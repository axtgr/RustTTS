# Roadmap: Qwen3-TTS Rust Engine

## Цели
- Rust-only реализация Qwen3-TTS (без Python, без torch).
- Минимальная latency до first audio; RTF < 0.2 на GPU.
- Streaming чанки 20–100 мс с overlap/crossfade.
- Поддержка CPU/GPU, CUDA backend, батчинг и QoS.
- Весы в safetensors, воспроизводимый build через `cargo`.

## Основные KPI
- Time-to-first-audio (GPU): 150–400 мс; CPU: 600–1500 мс.
- RTF: GPU < 0.2; CPU 0.8–2.0 (зависит от железа).
- Длительная стабильность: 10+ минут стрима без утечек.
- Детерминизм: опция фиксированного seed.

## Фазы
- Ф0: Подготовка и инфраструктура (конфиги, веса, CI-шаблон, базовые бенч/логи).
- Ф1: Текстовый пайплайн (нормализация RU/EN, токенизация совместимая с моделью).
- Ф2: Акустическая модель (трансформер, KV cache, streaming токены, CPU baseline).
- Ф3: Аудио-декодер Qwen3-TTS-Tokenizer-12Hz → PCM, чанки, overlap/crossfade.
- Ф4: Runtime/оркестрация (батчинг, QoS, очереди, structured logs, метрики).
- Ф5: Интеграция CLI/Server (streaming API, auth, health/metrics).
- Ф6: Оптимизация (CUDA backend, профили, бенчи, golden-тесты, стресс).

## Вехи (Definition of Done)
- Ф1 DoD: CLI сухой прогон — нормализованный текст → токены (dry-run).
- Ф2 DoD: Генерация стабильных speech-токенов, deterministic режим, KV cache.
- Ф3 DoD: Декодер выдаёт реальный звук, WAV экспорт, чанки без щелчков.
- Ф4 DoD: Потоковое воспроизведение, управляемый буфер, нет underrun/overrun.
- Ф5 DoD: CLI и сервис принимают текст, отдают аудио-стрим, метрики/health.
- Ф6 DoD: GPU ускорение, RTF<0.2 на реф. железе, бенч/голден-тесты зелёные.

## Временная оценка (итеративно)
- Ф0: 1 неделя.
- Ф1: 1–2 недели.
- Ф2: 2–3 недели.
- Ф3: 2 недели.
- Ф4: 1–2 недели.
- Ф5: 1 неделя.
- Ф6: 2 недели (параллелится частично с Ф4–Ф5).

## Зависимости и порядки
- Ф1 блокирует Ф2 (нужны стабильные токены).
- Ф2 блокирует Ф3 (нужны speech-токены).
- Ф3/Ф4 могут идти параллельно (декодер vs оркестрация), но интеграция после.
- Ф6 оптимизирует уже работающий конец-в-конец пайплайн.

## Риски верхнего уровня
- Несовместимость токенизации с референсом → падение качества.
- Неполный декодер 12Hz → артефакты/щелчки.
- KV-cache память на GPU при батчинге → OOM.
- CUDA/драйвер несостыковки; нужен fallback на CPU.
- Латентность первого чанка > целевой — требуется микро-батч/прогрев.

## Артефакты по фазам
- Ф0: templates конфигов, schema для model/config, мини-веса для CI, каркас CI.
- Ф1: правила нормализации, тест-корпус, golden токены.
- Ф2: конфиг трансформера, loader safetensors, sampling стратегии, KV cache.
- Ф3: декодер, overlap/crossfade, тестовые WAV/golden спектры.
- Ф4: runtime очереди, батчер, QoS политики, метрики/логи.
- Ф5: `tts-cli`, `tts-server` (опц.), контракты API, примеры запросов.
- Ф6: бенчмарки, профили, отчёт по RTF/latency, стресс-отчёт.
